<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
    :root {
        --primary-color: #2c3e50;
        --primary-light: #3a516b;
        --accent-color: #e74c3c;
        --accent-hover: #c0392b;
        --light-color: #ecf0f1;
        --dark-color: #34495e;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --info-color: #3498db;
        --font-main: 'Tajawal', sans-serif;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        --shadow-md: 0 4px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        --shadow-lg: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
        --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        direction: rtl;
    }

    body {
        font-family: var(--font-main);
        background-color: #f7f9fc;
        color: var(--dark-color);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }

    .container {
        width: 100%;
        max-width: 500px;
        background-color: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-md);
        position: relative;
    }

    /* Tabs Styling */
    .tabs {
        display: flex;
        background-color: var(--primary-color);
    }

    .tab {
        flex: 1;
        padding: 15px 0;
        text-align: center;
        color: var(--light-color);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .tab.active {
        background-color: var(--primary-light);
        color: white;
    }

    .tab:hover:not(.active) {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .tab::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 3px;
        background-color: var(--accent-color);
        transition: var(--transition);
    }

    .tab.active::after {
        width: 100%;
    }

    /* Form Styling */
    .form-container {
        padding: 30px;
        position: relative;
    }

    .form-section {
        display: none;
        animation: fadeIn 0.5s;
    }

    .form-section.active {
        display: block;
    }

    h1 {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 30px;
        font-size: 1.8rem;
        font-weight: 700;
    }

    .form-group {
        margin-bottom: 20px;
        position: relative;
    }

    label {
        display: block;
        margin-bottom: 8px;
        color: var(--dark-color);
        font-weight: 500;
    }

    input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        color: var(--dark-color);
        font-family: var(--font-main);
        transition: var(--transition);
    }

    input:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
    }

    button {
        display: block;
        width: 100%;
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        margin-top: 30px;
        font-family: var(--font-main);
    }

    button:hover {
        background-color: var(--accent-hover);
    }

    button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    /* Alert Box Styling */
    #alert-box {
        margin-bottom: 20px;
    }

    .alert {
        padding: 12px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        margin-bottom: 15px;
        position: relative;
        padding-left: 35px;
        animation: slideIn 0.3s;
    }

    .alert-success {
        background-color: rgba(46, 204, 113, 0.2);
        color: var(--success-color);
        border: 1px solid rgba(46, 204, 113, 0.3);
    }

    .alert-warning {
        background-color: rgba(243, 156, 18, 0.2);
        color: var(--warning-color);
        border: 1px solid rgba(243, 156, 18, 0.3);
    }

    .alert-danger {
        background-color: rgba(231, 76, 60, 0.2);
        color: var(--danger-color);
        border: 1px solid rgba(231, 76, 60, 0.3);
    }

    .alert-info {
        background-color: rgba(52, 152, 219, 0.2);
        color: var(--info-color);
        border: 1px solid rgba(52, 152, 219, 0.3);
    }

    .btn-close {
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 1.2rem;
        line-height: 1;
        cursor: pointer;
        background: none;
        border: none;
        color: inherit;
        width: auto;
        padding: 0;
        margin: 0;
    }

    .alert.fade.show {
        opacity: 1;
    }

    /* User Info Section */
    #user-info-section {
        text-align: center;
        padding: 20px;
    }

    .user-info {
        padding: 20px;
        border-radius: 8px;
        background-color: #f8f9fa;
        box-shadow: var(--shadow-sm);
    }

    .user-info h3 {
        margin-bottom: 15px;
        color: var(--primary-color);
    }

    .user-info p {
        margin-bottom: 20px;
        color: var(--dark-color);
    }

    #logout-btn {
        width: auto;
        margin: 0 auto;
        padding: 8px 20px;
        background-color: var(--danger-color);
    }

    /* Loading Spinner */
    #loading-spinner {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top: 4px solid var(--accent-color);
        animation: spin 1s linear infinite;
    }

    /* Password Strength Indicator */
    #password-strength-indicator {
        margin-top: 10px;
    }

    .progress {
        background-color: #ddd;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 5px;
        height: 5px;
    }

    .progress-bar {
        height: 100%;
        transition: var(--transition);
    }

    .bg-danger {
        background-color: var(--danger-color);
    }

    .bg-warning {
        background-color: var(--warning-color);
    }

    .bg-success {
        background-color: var(--success-color);
    }

    .text-danger {
        color: var(--danger-color);
    }

    .text-warning {
        color: var(--warning-color);
    }

    .text-success {
        color: var(--success-color);
    }

    small {
        font-size: 0.8rem;
        display: block;
    }

    /* Verification Status */
    .verification-status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
        text-align: center;
    }

    .status-unverified {
        background-color: rgba(243, 156, 18, 0.2);
        color: var(--warning-color);
    }

    .status-verified {
        background-color: rgba(46, 204, 113, 0.2);
        color: var(--success-color);
    }

    /* Custom Buttons for Email Verification */
    .verification-actions {
        margin-top: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .btn-outline {
        background-color: transparent;
        border: 1px solid;
        font-size: 0.9rem;
        padding: 8px 15px;
    }

    .btn-outline-primary {
        color: var(--accent-color);
        border-color: var(--accent-color);
    }

    .btn-outline-primary:hover {
        background-color: var(--accent-color);
        color: white;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateX(20px); }
        to { opacity: 1; transform: translateX(0); }
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Form focus state */
    .form-group.focused label {
        color: var(--accent-color);
        font-weight: 600;
    }

    /* Verification Info */
    .verification-info {
        display: none;
        background-color: rgba(52, 152, 219, 0.1);
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        position: relative;
    }

    .verification-info p {
        margin-bottom: 10px;
    }

    /* Email masking styles */
    .masked-email {
        font-family: monospace;
    }

    /* Countdown timer */
    .countdown {
        font-weight: bold;
        color: var(--accent-color);
    }

    /* Fade transition */
    .fade {
        transition: opacity 0.15s linear;
    }

    .fade:not(.show) {
        opacity: 0;
    }

    /* Responsive Styles */
    @media (max-width: 576px) {
        .container {
            max-width: 100%;
            border-radius: 0;
            box-shadow: none;
        }
        
        .form-container {
            padding: 20px 15px;
        }
        
        h1 {
            font-size: 1.5rem;
        }
        
        input, button {
            font-size: 0.95rem;
        }
        
        .verification-actions {
            flex-direction: column;
        }
    }

    /* Password visibility toggle */
    .password-toggle {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #777;
        cursor: pointer;
        width: auto;
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .password-container {
        position: relative;
    }

    .password-container input {
        padding-left: 40px;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        box-shadow: var(--shadow-lg);
        text-align: center;
    }

    .modal-title {
        margin-bottom: 15px;
        color: var(--primary-color);
        font-size: 1.3rem;
    }

    .modal-message {
        margin-bottom: 20px;
        color: var(--dark-color);
    }

    .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
    }

    .modal-btn {
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: var(--transition);
        width: auto;
        margin: 0;
    }

    .modal-btn-primary {
        background-color: var(--accent-color);
        color: white;
        border: none;
    }

    .modal-btn-primary:hover {
        background-color: var(--accent-hover);
    }

    .modal-btn-secondary {
        background-color: #f1f1f1;
        color: var(--dark-color);
        border: 1px solid #ddd;
    }

    .modal-btn-secondary:hover {
        background-color: #e5e5e5;
    }
</style>
</head>
<body>
    <div id="loading-spinner">
        <div class="spinner"></div>
    </div>
    
    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯ -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
            <p class="modal-message">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ</p>
            <div class="modal-buttons">
                <button id="confirm-logout" class="modal-btn modal-btn-primary">Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <button id="cancel-logout" class="modal-btn modal-btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" id="login-tab">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</div>
            <div class="tab" id="register-tab">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</div>
        </div>

        <div class="form-container">
            <div id="alert-box"></div>
            
            <!-- Ù‚Ø³Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
            <div class="form-section active" id="login-section">
                <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" id="login-email" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="login-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <div class="password-container">
                            <input type="password" id="login-password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required autocomplete="current-password">
                            <button type="button" class="password-toggle" tabindex="-1" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <button type="submit">Ø¯Ø®ÙˆÙ„</button>
                </form>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
            <div class="form-section" id="register-section">
                <h1>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
                <form id="register-form">
                    <div class="form-group">
                        <label for="register-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" id="register-email" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required autocomplete="email" pattern="[a-zA-Z0-9._%+-]+@gmail\.com$" title="ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Gmail ØµØ§Ù„Ø­">
                    </div>
                    <div class="form-group">
                        <label for="register-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <div class="password-container">
                            <input type="password" id="register-password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required autocomplete="new-password" title="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 8 Ø£Ø­Ø±ÙØŒ ÙˆØ­Ø±Ù ÙƒØ¨ÙŠØ±ØŒ ÙˆØ­Ø±Ù ØµØºÙŠØ±ØŒ ÙˆØ±Ù‚Ù…ØŒ ÙˆØ±Ù…Ø² Ø®Ø§Øµ">
                            <button type="button" class="password-toggle" tabindex="-1" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="register-password-confirm">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                        <div class="password-container">
                            <input type="password" id="register-password-confirm" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰" required autocomplete="new-password">
                            <button type="button" class="password-toggle" tabindex="-1" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <button type="submit">ØªØ³Ø¬ÙŠÙ„</button>
                </form>
            </div>

            <!-- Ù‚Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
            <div id="user-info-section" style="display: none;">
                <div class="user-info">
                    <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h3>
                    <p id="user-email"></p>
                    <button id="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
    // ØªÙ‡ÙŠØ¦Ø© Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBxdiEgTVpx7grXqOoFkmnDqQANvoZYGgs",
        authDomain: "zakbook-53053.firebaseapp.com", // ØªØµØ­ÙŠØ­ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        projectId: "zakbook-53053",
        storageBucket: "zakbook-53053.appspot.com", // Ø¥Ø¶Ø§ÙØ© Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ®Ø²ÙŠÙ†
        messagingSenderId: "123456789", // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±Ø³Ù„
        appId: "1:123456789:web:abc123def456" // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ù…Ø³Ø¨Ù‚Ù‹Ø§
    let app;
    if (!firebase.apps.length) {
        app = firebase.initializeApp(firebaseConfig);
    } else {
        app = firebase.app();
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Firestore
    db.settings({
        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
    });
    db.enablePersistence({ synchronizeTabs: true })
      .catch(err => {
        if (err.code == 'failed-precondition') {
            console.warn('Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·');
        } else if (err.code == 'unimplemented') {
            console.warn('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
      });

    // Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ù‡Ù…Ø© - Ø§Ø³ØªØ®Ø¯Ø§Ù… querySelector Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const elements = {
        loginTab: document.querySelector('#login-tab'),
        registerTab: document.querySelector('#register-tab'),
        loginSection: document.querySelector('#login-section'),
        registerSection: document.querySelector('#register-section'),
        userInfoSection: document.querySelector('#user-info-section'),
        userEmailElement: document.querySelector('#user-email'),
        logoutBtn: document.querySelector('#logout-btn'),
        loginForm: document.querySelector('#login-form'),
        registerForm: document.querySelector('#register-form'),
        alertBox: document.querySelector('#alert-box'),
        loginEmail: document.querySelector('#login-email'),
        loginPassword: document.querySelector('#login-password'),
        registerEmail: document.querySelector('#register-email'),
        registerPassword: document.querySelector('#register-password'),
        registerPasswordConfirm: document.querySelector('#register-password-confirm'),
        passwordToggles: document.querySelectorAll('.password-toggle'),
        loadingSpinner: document.querySelector('#loading-spinner'),
        confirmModal: document.querySelector('#confirm-modal'),
        confirmLogoutBtn: document.querySelector('#confirm-logout'),
        cancelLogoutBtn: document.querySelector('#cancel-logout')
    };

    // ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const validationUtils = {
        isValidGmail: (email) => {
            if (!email || typeof email !== 'string') return false;
            
            // Ø§Ù„ØªØ¹Ø¨ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¸Ù… Ø§Ù„Ù…Ø¨Ø³Ø· Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯ Gmail
            return /^[a-zA-Z0-9]([a-zA-Z0-9._-]{3,28})[a-zA-Z0-9]@gmail\.com$/i.test(email);
        },
        
        isStrongPassword: (password) => {
            if (!password || typeof password !== 'string') return false;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            const hasMinLength = password.length >= 6;
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasDigit = /\d/.test(password);
            
            return hasMinLength && hasUpperCase && hasLowerCase && hasDigit;
        },
        
        getPasswordStrength: (password) => {
            if (!password) return { score: 0, feedback: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙØ§Ø±ØºØ©', level: 'Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ù‹Ø§' };
            
            let score = 0;
            let feedback = [];
            
            // ØªÙ‚ÙŠÙŠÙ… Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            if (password.length >= 6) score += 1;
            if (password.length >= 10) score += 1;
            if (/[A-Z]/.test(password)) score += 1;
            if (/[a-z]/.test(password)) score += 1;
            if (/\d/.test(password)) score += 1;
            if (/[@$!%*?&]/.test(password)) score += 1;
            
            // ØªØ­Ø¶ÙŠØ± ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø­ÙˆÙ„ Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            if (password.length < 6) {
                feedback.push('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§');
            }
            if (!/[A-Z]/.test(password)) {
                feedback.push('Ø£Ø¶Ù Ø­Ø±Ù ÙƒØ¨ÙŠØ±');
            }
            if (!/[a-z]/.test(password)) {
                feedback.push('Ø£Ø¶Ù Ø­Ø±Ù ØµØºÙŠØ±');
            }
            if (!/\d/.test(password)) {
                feedback.push('Ø£Ø¶Ù Ø±Ù‚Ù…');
            }
            if (!/[@$!%*?&]/.test(password)) {
                feedback.push('ÙŠÙØ¶Ù„ Ø¥Ø¶Ø§ÙØ© Ø±Ù…Ø² Ø®Ø§Øµ');
            }
            
            // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰ Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            let level = 'Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ù‹Ø§';
            if (score >= 5) {
                level = 'Ù‚ÙˆÙŠØ© Ø¬Ø¯Ù‹Ø§';
            } else if (score >= 4) {
                level = 'Ù‚ÙˆÙŠØ©';
            } else if (score >= 3) {
                level = 'Ù…ØªÙˆØ³Ø·Ø©';
            } else if (score >= 2) {
                level = 'Ø¶Ø¹ÙŠÙØ©';
            }
            
            return { 
                score: score, 
                feedback: feedback.length ? feedback.join('ØŒ ') : 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¬ÙŠØ¯Ø©',
                level: level
            };
        },
        
        maskEmail: (email) => {
            if (!email || typeof email !== 'string') return '';
            
            const parts = email.split('@');
            if (parts.length !== 2) return email;
            
            const username = parts[0];
            const domain = parts[1];
            
            // Ø­Ø¬Ø¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            let maskedUsername;
            if (username.length <= 2) {
                maskedUsername = '*'.repeat(username.length);
            } else {
                maskedUsername = username.charAt(0) + '*'.repeat(username.length - 2) + username.charAt(username.length - 1);
            }
            
            return `${maskedUsername}@${domain}`;
        },
        
        // ÙˆØ¸ÙŠÙØ© Ù…Ø¶Ø§ÙØ© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…ØªÙŠ Ø§Ù„Ù…Ø±ÙˆØ±
        passwordsMatch: (password, confirmPassword) => {
            return password === confirmPassword;
        }
    };

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const uiHandlers = {
        showAlert: (message, type, duration = 3000) => {
            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ£ÙŠÙ‚ÙˆÙ†ØªÙ‡
            const alertClass = type === 'error' ? 'danger' : type;
            const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : type === 'warning' ? 'âš ï¸' : 'â„¹';
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            elements.alertBox.innerHTML = `
                <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                    <strong>${icon}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
                </div>
            `;
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
            const closeBtn = elements.alertBox.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    const alert = elements.alertBox.querySelector('.alert');
                    if (alert) {
                        alert.classList.remove('show');
                        setTimeout(() => elements.alertBox.innerHTML = '', 150);
                    }
                });
            }
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            if (duration > 0) {
                setTimeout(() => {
                    const alert = elements.alertBox.querySelector('.alert');
                    if (alert) {
                        alert.classList.remove('show');
                        setTimeout(() => elements.alertBox.innerHTML = '', 150);
                    }
                }, duration);
            }
        },
        
        showLoginTab: () => {
            elements.loginTab.classList.add('active');
            elements.registerTab.classList.remove('active');
            elements.loginSection.classList.add('active');
            elements.registerSection.classList.remove('active');
            
            // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            elements.alertBox.innerHTML = '';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            elements.loginForm.reset();
        },
        
        showRegisterTab: () => {
            elements.registerTab.classList.add('active');
            elements.loginTab.classList.remove('active');
            elements.registerSection.classList.add('active');
            elements.loginSection.classList.remove('active');
            
            // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            elements.alertBox.innerHTML = '';
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            elements.registerForm.reset();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¤Ø´Ø± Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            const strengthIndicator = document.querySelector('#password-strength-indicator');
            if (strengthIndicator) {
                strengthIndicator.innerHTML = '';
            }
        },
        
        showLoading: (isLoading) => {
            if (isLoading) {
                elements.loadingSpinner.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            } else {
                elements.loadingSpinner.style.display = 'none';
                document.body.style.overflow = '';
            }
        },
        
        updateUIOnLogin: (user) => {
            if (!user) return;
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            elements.userEmailElement.textContent = user.email || 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„';
            elements.userInfoSection.style.display = 'block';
            elements.loginSection.style.display = 'none';
            elements.registerSection.style.display = 'none';
            elements.loginTab.style.display = 'none';
            elements.registerTab.style.display = 'none';
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            if (!user.emailVerified) {
                // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                let verificationInfo = document.querySelector('.verification-info');
                
                if (!verificationInfo) {
                    verificationInfo = document.createElement('div');
                    verificationInfo.className = 'verification-info';
                    elements.userInfoSection.appendChild(verificationInfo);
                }
                
                verificationInfo.innerHTML = `
                    <div class="verification-status status-unverified">
                        <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø¤ÙƒØ¯</strong>
                    </div>
                    <p>Ù„Ù‚Ø¯ Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ <span class="masked-email">${validationUtils.maskEmail(user.email)}</span>. 
                    ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
                    <div class="verification-actions">
                        <button id="resend-verification-btn" class="btn-outline btn-outline-primary">Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ£ÙƒÙŠØ¯</button>
                        <button id="refresh-verification-btn" class="btn-outline btn-outline-primary">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚</button>
                    </div>
                    <small>Ù„Ù… ØªØ³ØªÙ„Ù… Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯ØŸ ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø²Ø¹Ø¬ Ø£Ùˆ Ø£Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.</small>
                `;
                
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
                const resendBtn = document.querySelector('#resend-verification-btn');
                const refreshBtn = document.querySelector('#refresh-verification-btn');
                
                if (resendBtn) {
                    resendBtn.addEventListener('click', authHandlers.resendVerificationEmail);
                }
                
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        uiHandlers.showLoading(true);
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
                        user.reload().then(() => {
                            uiHandlers.showLoading(false);
                            uiHandlers.updateUIOnLogin(auth.currentUser);
                        }).catch(error => {
                            uiHandlers.showLoading(false);
                            uiHandlers.showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚: ' + error.message, 'error');
                        });
                    });
                }
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚
                verificationInfo.style.display = 'block';
                
                // Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚
                uiHandlers.showAlert('ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„', 'warning', 5000);
                
                // ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
                elements.logoutBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬';
            } else {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤ÙƒØ¯ØŒ Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                let verificationInfo = document.querySelector('.verification-info');
                
                if (!verificationInfo) {
                    verificationInfo = document.createElement('div');
                    verificationInfo.className = 'verification-info';
                    elements.userInfoSection.appendChild(verificationInfo);
                }
                
                verificationInfo.innerHTML = `
                    <div class="verification-status status-verified">
                        <strong>ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­</strong>
                    </div>
                    <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹.</p>
                `;
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚
                verificationInfo.style.display = 'block';
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                uiHandlers.showAlert('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©...', 'success', 2000);
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                setTimeout(() => {
                    try {
                        window.location.href = window.location.origin + "/index";
                    } catch (e) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡:', e);
                        uiHandlers.showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.', 'error');
                    }
                }, 2000);
            }
        },
        
        updateUIOnLogout: () => {
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            elements.userInfoSection.style.display = 'none';
            elements.loginTab.style.display = 'block';
            elements.registerTab.style.display = 'block';
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            uiHandlers.showLoginTab();
            
            // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            elements.userEmailElement.textContent = '';
            
            // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
            elements.loginForm.reset();
            elements.registerForm.reset();
            
            // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            const strengthIndicator = document.querySelector('#password-strength-indicator');
            if (strengthIndicator) {
                strengthIndicator.innerHTML = '';
            }
        },
        
        // ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        togglePasswordVisibility: (inputElement, toggleButton) => {
            const type = inputElement.getAttribute('type') === 'password' ? 'text' : 'password';
            inputElement.setAttribute('type', type);
            toggleButton.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸';
        },
        
        // ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯
        showConfirmModal: () => {
            elements.confirmModal.style.display = 'flex';
        },
        
        // ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø®ÙØ§Ø¡ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯
        hideConfirmModal: () => {
            elements.confirmModal.style.display = 'none';
        }
    };

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Firebase
    const authHandlers = {
        login: async (email, password) => {
            try {
                uiHandlers.showLoading(true);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                if (!email || !password) {
                    uiHandlers.showLoading(false);
                    uiHandlers.showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
                    return false;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                if (!validationUtils.isValidGmail(email)) {
                    uiHandlers.showLoading(false);
                    uiHandlers.showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Gmail ØµØ§Ù„Ø­', 'error');
                    return false;
                }
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                const loginTimestamp = firebase.firestore.FieldValue.serverTimestamp();
                
                // Ø­ÙØ¸ Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                localStorage.setItem('lastLoginTime', new Date().toISOString());
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙÙŠ Firestore
                try {
                    await db.collection('users').doc(userCredential.user.uid).update({
                        lastLogin: loginTimestamp,
                        lastLoginDevice: navigator.userAgent
                    });
                } catch (error) {
                    console.warn('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                    try {
                        await db.collection('users').doc(userCredential.user.uid).set({
                            email: userCredential.user.email,
                            emailVerified: userCredential.user.emailVerified,
                            createdAt: loginTimestamp,
                            lastLogin: loginTimestamp,
                            lastLoginDevice: navigator.userAgent
                        }, { merge: true });
                    } catch (e) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', e);
                    }
                }
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                uiHandlers.showAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø§Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ§Ø´Ù„Ø©
                resetFailedLoginAttempts();
                
                uiHandlers.showLoading(false);
                return true;
            } catch (error) {
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                let errorMessage;
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'ØªÙ… ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø¨Ø³Ø¨Ø¨ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªÙƒØ±Ø±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                        break;
                    default:
                        errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message;
                }
                
                uiHandlers.showLoading(false);
                uiHandlers.showAlert(errorMessage, 'error');
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ§Ø´Ù„Ø©
                updateFailedLoginAttempts();
                
                return false;
            }
        },
        
        register: async (email, password, passwordConfirm) => {
            try {
                uiHandlers.showLoading(true);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                if (!email || !password || !passwordConfirm) {
                    uiHandlers.showLoading(false);
                    uiHandlers.showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
                    return false;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                if (!validationUtils.isValidGmail(email)) {
                    uiHandlers.showLoading(false);
                    uiHandlers.showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Gmail ØµØ§Ù„Ø­', 'error');
                    return false;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…ØªÙŠ Ø§Ù„Ù…Ø±ÙˆØ±
                if (!validationUtils.passwordsMatch(password, passwordConfirm)) {
                    uiHandlers.showLoading(false);
                    uiHandlers.showAlert('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†', 'error');
                    return false;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                if (!validationUtils.isStrongPassword(password)) {
                    const passwordStrength = validationUtils.getPasswordStrength(password);
                    uiHandlers.showLoading(false);
                    uiHandlers.showAlert(`ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ${passwordStrength.level}: ${passwordStrength.feedback}`, 'error');
                    return false;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯
                await userCredential.user.sendEmailVerification({
                    url: window.location.origin + '/index'
                });
                
                // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: email,
                    emailVerified: false,
                    createdAt: timestamp,
                    lastLogin: timestamp,
                    registrationDevice: navigator.userAgent,
                    lastLoginDevice: navigator.userAgent
                });
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù‚ØµÙŠØ±
                setTimeout(() => {
                    uiHandlers.showLoading(false);
                    uiHandlers.showAlert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'success');
                }, 500);
                
                return true;
            } catch (error) {
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                let errorMessage;
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 6 Ø£Ø­Ø±Ù';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø¹Ø·Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                        break;
                    default:
                        errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: ' + error.message;
                }
                
                uiHandlers.showLoading(false);
                uiHandlers.showAlert(errorMessage, 'error');
                return false;
            }
        },
        
        logout: async () => {
            try {
                uiHandlers.showLoading(true);
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Firebase
                await auth.signOut();
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                uiHandlers.showAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                uiHandlers.updateUIOnLogout();
                
                uiHandlers.showLoading(false);
                return true;
            } catch (error) {
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ' + error.message;
                uiHandlers.showLoading(false);
                uiHandlers.showAlert(errorMessage, 'error');
                return false;
            }
        },
        
        resendVerificationEmail: async () => {
            try {
                uiHandlers.showLoading(true);
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠ
                const user = auth.currentUser;
                if (!user) {
                    uiHandlers.showLoading(false);
                    uiHandlers.showAlert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                    return false;
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯
                if (user.emailVerified) {
                    uiHandlers.showLoading(false);
                    uiHandlers.showAlert('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø¤ÙƒØ¯ Ø¨Ø§Ù„ÙØ¹Ù„', 'info');
                    return true;
                }
                
                // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø¤Ù‚ØªÙ‹Ø§
                const resendBtn = document.querySelector('#resend-verification-btn');
                if (resendBtn) {
                    resendBtn.disabled = true;
                    
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ù‚Øª Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ
                    let countdown = 60;
                    resendBtn.innerHTML = `Ø§Ù†ØªØ¸Ø± (<span class="countdown">${countdown}</span> Ø«Ø§Ù†ÙŠØ©)`;
                    
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        const countdownSpan = resendBtn.querySelector('.countdown');
                        if (countdownSpan) {
                            countdownSpan.textContent = countdown;
                        }
                        
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            resendBtn.disabled = false;
                            resendBtn.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ£ÙƒÙŠØ¯';
                        }
                    }, 1000);
                }
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯
                await user.sendEmailVerification({
                    url: window.location.origin + '/index'
                });
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                uiHandlers.showLoading(false);
                uiHandlers.showAlert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'success');
                
                return true;
            } catch (error) {
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯
                let errorMessage;
                
                switch (error.code) {
                    case 'auth/too-many-requests':
                        errorMessage = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                        break;
                    default:
                        errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯: ' + error.message;
                }
                
                uiHandlers.showLoading(false);
                uiHandlers.showAlert(errorMessage, 'error');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
                const resendBtn = document.querySelector('#resend-verification-btn');
                if (resendBtn) {
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ£ÙƒÙŠØ¯';
                }
                
                return false;
            }
        }
    };

    // ØªØ­Ø³ÙŠÙ† Ø£Ù…Ø§Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    const MAX_FAILED_ATTEMPTS = 5;
    const LOCKOUT_TIME = 15 * 60 * 1000; // 15 Ø¯Ù‚ÙŠÙ‚Ø©

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    const checkLoginLock = () => {
        const lockTime = localStorage.getItem('loginLockTime');
        if (lockTime) {
            const lockUntil = parseInt(lockTime, 10);
            const now = Date.now();
            
            if (now < lockUntil) {
                const remainingMinutes = Math.ceil((lockUntil - now) / 60000);
                uiHandlers.showAlert(`ØªÙ… ØªÙ‚ÙŠÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚ØªÙ‹Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ${remainingMinutes} Ø¯Ù‚Ø§Ø¦Ù‚`, 'error', 0);
                
                // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                const loginButton = elements.loginForm.querySelector('button[type="submit"]');
                if (loginButton) {
                    loginButton.disabled = true;
                }
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø©
                setTimeout(checkLoginLock, 60000);
                
                return true;
            } else {
                // Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ù„Ù‚ÙÙ„ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
                resetFailedLoginAttempts();
            }
        }
        return false;
    };

    // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ§Ø´Ù„Ø©
    const updateFailedLoginAttempts = () => {
        let failedAttempts = parseInt(localStorage.getItem('failedLoginAttempts') || '0', 10) + 1;
        localStorage.setItem('failedLoginAttempts', failedAttempts.toString());
        
        if (failedAttempts >= MAX_FAILED_ATTEMPTS) {
            // Ù‚ÙÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­
            const lockUntil = Date.now() + LOCKOUT_TIME;
            localStorage.setItem('loginLockTime', lockUntil.toString());
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±
            uiHandlers.showAlert(`ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. ØªÙ… ØªÙ‚ÙŠÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù…Ø¯Ø© 15 Ø¯Ù‚ÙŠÙ‚Ø©`, 'error', 0);
            
            // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            const loginButton = elements.loginForm.querySelector('button[type="submit"]');
            if (loginButton) {
                loginButton.disabled = true;
            }
        } else {
            // Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
            const remainingAttempts = MAX_FAILED_ATTEMPTS - failedAttempts;
            uiHandlers.showAlert(`Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${remainingAttempts}`, 'warning');
        }
    };

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ§Ø´Ù„Ø©
    const resetFailedLoginAttempts = () => {
        localStorage.removeItem('failedLoginAttempts');
        localStorage.removeItem('loginLockTime');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const loginButton = elements.loginForm.querySelector('button[type="submit"]');
        if (loginButton) {
            loginButton.disabled = false;
        }
    };

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¹Ù†Ø§ØµØ±
    document.addEventListener('DOMContentLoaded', () => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        checkLoginLock();
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø´Ø§Ø´Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
        elements.loginTab.addEventListener('click', uiHandlers.showLoginTab);
        elements.registerTab.addEventListener('click', uiHandlers.showRegisterTab);
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        elements.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            if (checkLoginLock()) return;
            
            const email = elements.loginEmail.value.trim();
            const password = elements.loginPassword.value;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            const success = await authHandlers.login(email, password);
            
            if (success) {
                elements.loginForm.reset();
            }
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
        elements.registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = elements.registerEmail.value.trim();
            const password = elements.registerPassword.value;
            const passwordConfirm = elements.registerPasswordConfirm.value;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
            const success = await authHandlers.register(email, password, passwordConfirm);
            
            if (success) {
                elements.registerForm.reset();
            }
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ - Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯
        elements.logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            uiHandlers.showConfirmModal();
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        elements.confirmLogoutBtn.addEventListener('click', async () => {
            uiHandlers.hideConfirmModal();
            await authHandlers.logout();
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù„ØºØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        elements.cancelLogoutBtn.addEventListener('click', () => {
            uiHandlers.hideConfirmModal();
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø­Ø¯Ø« Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        elements.passwordToggles.forEach(toggle => {
            toggle.addEventListener('click', (e) => {
                // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·
                const passwordField = e.currentTarget.closest('.password-container').querySelector('input');
                uiHandlers.togglePasswordVisibility(passwordField, e.currentTarget);
            });
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
        if (elements.registerPassword) {
            elements.registerPassword.addEventListener('input', (e) => {
                const password = e.target.value;
                const strengthResult = validationUtils.getPasswordStrength(password);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                let strengthIndicator = document.querySelector('#password-strength-indicator');
                
                if (!strengthIndicator) {
                    strengthIndicator = document.createElement('div');
                    strengthIndicator.id = 'password-strength-indicator';
                    strengthIndicator.className = 'mt-2';
                    e.target.closest('.form-group').appendChild(strengthIndicator);
                }
                
                // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ù…Ø¤Ø´Ø± Ø­Ø³Ø¨ Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                const strengthClass = strengthResult.score < 3 ? 'danger' : 
                                    strengthResult.score < 5 ? 'warning' : 'success';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¤Ø´Ø±
                strengthIndicator.innerHTML = `
                    <div class="progress">
                        <div class="progress-bar bg-${strengthClass}" 
                             style="width: ${(strengthResult.score / 6) * 100}%; height: 5px;" 
                             role="progressbar"></div>
                    </div>
                    <small class="text-${strengthClass}">${strengthResult.level}: ${strengthResult.feedback}</small>
                `;
            });
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
            elements.registerPasswordConfirm.addEventListener('input', (e) => {
                const password = elements.registerPassword.value;
                const confirmPassword = e.target.value;
                
                if (confirmPassword && password) {
                    const matchResult = validationUtils.passwordsMatch(password, confirmPassword);
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± ØªØ·Ø§Ø¨Ù‚ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
                    let matchIndicator = e.target.closest('.form-group').querySelector('.password-match-indicator');
                    
                    if (!matchIndicator) {
                        matchIndicator = document.createElement('div');
                        matchIndicator.className = 'password-match-indicator mt-2';
                        e.target.closest('.form-group').appendChild(matchIndicator);
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ·Ø§Ø¨Ù‚
                    if (matchResult) {
                        matchIndicator.innerHTML = `<small class="text-success">âœ“ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©</small>`;
                    } else {
                        matchIndicator.innerHTML = `<small class="text-danger">âœ— ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©</small>`;
                    }
                }
            });
        }
        
        // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
        const inputFields = document.querySelectorAll('input');
        inputFields.forEach(field => {
            // Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ù„Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ²
            field.addEventListener('focus', () => {
                field.closest('.form-group').classList.add('focused');
            });
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø© Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹
            field.addEventListener('blur', () => {
                if (!field.value.trim()) {
                    field.closest('.form-group').classList.remove('focused');
                }
            });
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ¦Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„ÙØ¹Ù„
            if (field.value.trim()) {
                field.closest('.form-group').classList.add('focused');
            }
        });
        
        // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        window.addEventListener('click', (e) => {
            if (e.target === elements.confirmModal) {
                uiHandlers.hideConfirmModal();
            }
        });
    });

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    auth.onAuthStateChanged(async (user) => {
        try {
            if (user) {
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                await user.reload();
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø«
                const updatedUser = auth.currentUser;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore
                try {
                    await db.collection('users').doc(updatedUser.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                        emailVerified: updatedUser.emailVerified,
                        lastLoginDevice: navigator.userAgent
                    });
                } catch (error) {
                    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                    if (error.code === 'not-found') {
                        try {
                            await db.collection('users').doc(updatedUser.uid).set({
                                email: updatedUser.email,
                                emailVerified: updatedUser.emailVerified,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                                lastLoginDevice: navigator.userAgent
                            });
                        } catch (e) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', e);
                        }
                    } else {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                uiHandlers.updateUIOnLogin(updatedUser);
            } else {
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                uiHandlers.updateUIOnLogout();
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
            uiHandlers.showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
        } finally {
            // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            uiHandlers.showLoading(false);
        }
    });
</script>
</body>
</html>
